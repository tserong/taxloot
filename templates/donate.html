<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Donate Today</title>
    <!-- Bootstrap -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-formhelpers.min.css" rel="stylesheet">
    <link href="/static/css/calc.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
  </head>
  <body>
        <div class="header">
            <h1>Make a tax deductible donation today. Help us spread the
            pirate message</h1>
            <ul class="progress-bar">
                <li class="visited" id="progress-details">Details</li>
                <li class="unvisited" id="progress-payment">Payment</li>
                <li class="unvisited" id="progress-confirm">Confirm</li>
                <li class="unvisited" id="progress-finish">Finish</li>
            </ul>
        </div>
    <div class="container">
    <div class="form-container">
    <form action="/donate" method="POST">        
      <div id="details-form">
      <div class="row">
        <div class="col-sm-9">
        <p>Details</p>
        </div>
      </div>
      </div>

      <div id="payment-form">
      <div class="row">
        <div class="col-sm-9">
        <p>Details</p>
        </div>
      </div>
      </div>
      <div id="confirm-form">
      <div class="row">
        <div class="col-sm-9">
        <p>Details</p>
        </div>
      </div>
      </div>
      <div id="finish-form">
      <div class="row">
        <div class="col-sm-9">
        <p>Details</p>
        </div>
      </div>
      </div>

    </form>
    </div>
    </div>

    <script src="/static/js/jquery-1.12.0.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/bootstrap-formhelpers.min.js"></script>
    <script>
    var brackets = [ { min: 0, max: 18200, rate: 0, base: 0},
                    { min: 18201, max: 37000, rate: 0.19, base: 0 },
                    { min: 37001, max: 80000, rate: 0.325, base: 3572},
                    { min: 80001, max: 180000, rate: 0.37, base: 17547},
                    { min: 180001, max: 1000000000000000, rate: 0.45, base: 54547}
                    ];
    function calc_return(income, donation) {
        var real_income = income - donation;
        var pre_bracket = 0;
        var real_bracket = 0;
        // Calculate bracket for original taxable income
        for (var i=brackets.length-1; i>=0; i--) {
            if (income >= brackets[i].min && income <= brackets[i].max) {
                pre_bracket = i;                
            }
        }

        // Calculate bracket for post-deduction income
        for (var i=brackets.length-1; i>=0; i--) {
            if (real_income >= brackets[i].min && real_income <= brackets[i].max) {
                real_bracket = i;
            }
        }
                
        // Calculate tax (without donation)
        var tax = 0;
        tax = brackets[pre_bracket].base + ((income-brackets[pre_bracket].min) * brackets[pre_bracket].rate);

        // Calculate tax (with donation)
        var real_tax = 0;
        real_tax = brackets[real_bracket].base + ((real_income-brackets[real_bracket].min) * brackets[real_bracket].rate);

        return Math.floor(tax - real_tax);
    }

    function update_donation_amount(event) {
        console.log("in update");
        var amt = $("input[name=donationRadio]:checked").val();
        if (amt == "Custom") {
            $("#donationAmount").prop("disabled", false);
            $("#donationAmount").val(500);
        } else {
            $("#donationAmount").prop("disabled", true);
            $("#donationAmount").val(amt);
        }
        recalculate_and_update(null);    
    }

    // Grab form variables, validate and recalculate
    function recalculate_and_update(event) {
       var donationAmount = $("#donationAmount").val();
       if (donationAmount > 1500) {
           donationAmount = 1500;
           $("#donationAmount").val("1500");
       }
       var incomeAmount = $("#incomeAmount").val();
       var estReturn = calc_return(incomeAmount, donationAmount);
       $("#estReturnAmount").val(estReturn);
       $("#returnAmount").text("$" + estReturn);
    }

$(document).ready(function() {
    // placeholder for now but this should redirect to the donation page
    // with their amount prefilled     


    // Assign event functions
    $("#donationAmount").keypress(recalculate_and_update);
    $("#incomeAmount").keypress(recalculate_and_update);
    $("#donationAmount").change(recalculate_and_update);
    $("#incomeAmount").change(recalculate_and_update);
    
    $("input[name=donationRadio]").change(update_donation_amount);
    
    $("#makeDonationBtn").click(function(evt) { evt.preventDefault(); });
    $("#donationAmount").val(500);
    recalculate_and_update(null);
});    
    </script>
  </body>
</html>
